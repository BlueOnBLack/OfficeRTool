# Ohook Manual activation
# https://massgrave.dev/manual_ohook_activation

# Define the KeyBlock function to create a hash table
$KeyBlock = @'
SKU,KEY
O365BusinessRetail,Y9NF9-M2QWD-FF6RJ-QJW36-RRF2T
O365EduCloudRetail,W62NQ-267QR-RTF74-PF2MH-JQMTH
O365HomePremRetail,3NMDC-G7C3W-68RGP-CB4MH-4CXCH
O365ProPlusRetail,H8DN8-Y2YP3-CR9JT-DHDR9-C7GP3
O365SmallBusPremRetail,2QCNB-RMDKJ-GC8PB-7QGQV-7QTQJ
O365AppsBasicRetail,3HYJN-9KG99-F8VG9-V3DT8-JFMHV
AccessRetail,WHK4N-YQGHB-XWXCC-G3HYC-6JF94
AccessRuntimeRetail,RNB7V-P48F4-3FYY6-2P3R3-63BQV
ExcelRetail,RKJBN-VWTM2-BDKXX-RKQFD-JTYQ2
HomeBusinessPipcRetail,2WQNF-GBK4B-XVG6F-BBMX7-M4F2Y
HomeBusinessRetail,HM6FM-NVF78-KV9PM-F36B8-D9MXD
HomeStudentARMRetail,PBQPJ-NC22K-69MXD-KWMRF-WFG77
HomeStudentPlusARMRetail,6F2NY-7RTX4-MD9KM-TJ43H-94TBT
HomeStudentRetail,PNPRV-F2627-Q8JVC-3DGR9-WTYRK
HomeStudentVNextRetail,YWD4R-CNKVT-VG8VJ-9333B-RC3B8
MondoRetail,VNWHF-FKFBW-Q2RGD-HYHWF-R3HH2
OneNoteFreeRetail,XYNTG-R96FY-369HX-YFPHY-F9CPM
OneNoteRetail,FXF6F-CNC26-W643C-K6KB7-6XXW3
OutlookRetail,7N4KG-P2QDH-86V9C-DJFVF-369W9
PersonalPipcRetail,9CYB3-NFMRW-YFDG6-XC7TF-BY36J
PersonalRetail,FT7VF-XBN92-HPDJV-RHMBY-6VKBF
PowerPointRetail,N7GCB-WQT7K-QRHWG-TTPYD-7T9XF
ProPlusRetail,GM43N-F742Q-6JDDK-M622J-J8GDV
ProfessionalPipcRetail,CF9DD-6CNW2-BJWJQ-CVCFX-Y7TXD
ProfessionalRetail,NXFTK-YD9Y7-X9MMJ-9BWM6-J2QVH
ProjectProRetail,WPY8N-PDPY4-FC7TF-KMP7P-KWYFY
ProjectStdRetail,NTHQT-VKK6W-BRB87-HV346-Y96W8
PublisherRetail,WKWND-X6G9G-CDMTV-CPGYJ-6MVBF
SkypeServiceBypassRetail,6MDN4-WF3FV-4WH3Q-W699V-RGCMY
SkypeforBusinessEntryRetail,4N4D8-3J7Y3-YYW7C-73HD2-V8RHY
SkypeforBusinessRetail,PBJ79-77NY4-VRGFG-Y8WYC-CKCRC
StandardRetail,2FPWN-4H6CM-KD8QQ-8HCHC-P9XYW
VisioProRetail,NVK2G-2MY4G-7JX2P-7D6F2-VFQBR
VisioStdRetail,NCRB7-VP48F-43FYY-62P3R-367WK
WordRetail,P8K82-NQ7GG-JKY8T-6VHVY-88GGD
Access2019Retail,WRYJ6-G3NP7-7VH94-8X7KP-JB7HC
AccessRuntime2019Retail,FGQNJ-JWJCG-7Q8MG-RMRGJ-9TQVF
Excel2019Retail,KBPNW-64CMM-8KWCB-23F44-8B7HM
HomeBusiness2019Retail,QBN2Y-9B284-9KW78-K48PB-R62YT
HomeStudentARM2019Retail,DJTNY-4HDWM-TDWB2-8PWC2-W2RRT
HomeStudentPlusARM2019Retail,NM8WT-CFHB2-QBGXK-J8W6J-GVK8F
HomeStudent2019Retail,XNWPM-32XQC-Y7QJC-QGGBV-YY7JK
Outlook2019Retail,WR43D-NMWQQ-HCQR2-VKXDR-37B7H
Personal2019Retail,NMBY8-V3CV7-BX6K6-2922Y-43M7T
PowerPoint2019Retail,HN27K-JHJ8R-7T7KK-WJYC3-FM7MM
ProPlus2019Retail,BN4XJ-R9DYY-96W48-YK8DM-MY7PY
Professional2019Retail,9NXDK-MRY98-2VJV8-GF73J-TQ9FK
ProjectPro2019Retail,JDTNC-PP77T-T9H2W-G4J2J-VH8JK
ProjectStd2019Retail,R3JNT-8PBDP-MTWCK-VD2V8-HMKF9
Publisher2019Retail,4QC36-NW3YH-D2Y9D-RJPC7-VVB9D
SkypeforBusiness2019Retail,JBDKF-6NCD6-49K3G-2TV79-BKP73
SkypeforBusinessEntry2019Retail,N9722-BV9H6-WTJTT-FPB93-978MK
Standard2019Retail,NDGVM-MD27H-2XHVC-KDDX2-YKP74
VisioPro2019Retail,2NWVW-QGF4T-9CPMB-WYDQ9-7XP79
VisioStd2019Retail,263WK-3N797-7R437-28BKG-3V8M8
Word2019Retail,JXR8H-NJ3MK-X66W8-78CWD-QRVR2
Access2021Retail,P286B-N3XYP-36QRQ-29CMP-RVX9M
AccessRuntime2021Retail,MNX9D-PB834-VCGY2-K2RW2-2DP3D
Excel2021Retail,V6QFB-7N7G9-PF7W9-M8FQM-MY8G9
HomeBusiness2021Retail,JM99N-4MMD8-DQCGJ-VMYFY-R63YK
HomeStudent2021Retail,N3CWD-38XVH-KRX2Y-YRP74-6RBB2
OneNoteFree2021Retail,CNM3W-V94GB-QJQHH-BDQ3J-33Y8H
OneNote2021Retail,NB2TQ-3Y79C-77C6M-QMY7H-7QY8P
Outlook2021Retail,4NCWR-9V92Y-34VB2-RPTHR-YTGR7
Personal2021Retail,RRRYB-DN749-GCPW4-9H6VK-HCHPT
PowerPoint2021Retail,3KXXQ-PVN2C-8P7YY-HCV88-GVM96
ProPlus2021Retail,8WXTP-MN628-KY44G-VJWCK-C7PCF
Professional2021Retail,DJPHV-NCJV6-GWPT6-K26JX-C7PBG
ProjectPro2021Retail,QKHNX-M9GGH-T3QMW-YPK4Q-QRWMV
ProjectStd2021Retail,2B96V-X9NJY-WFBRC-Q8MP2-7CHRR
Publisher2021Retail,CDNFG-77T8D-VKQJX-B7KT3-KK28V
SkypeforBusiness2021Retail,DVBXN-HFT43-CVPRQ-J89TF-VMMHG
Standard2021Retail,HXNXB-J4JGM-TCF44-2X2CV-FJVVH
VisioPro2021Retail,T6P26-NJVBR-76BK8-WBCDY-TX3BC
VisioStd2021Retail,89NYY-KB93R-7X22F-93QDF-DJ6YM
Word2021Retail,VNCC4-CJQVK-BKX34-77Y8H-CYXMR
Access2024Retail,P6NMW-JMTRC-R6MQ6-HH3F2-BTHKB
Excel2024Retail,82CNJ-W82TW-BY23W-BVJ6W-W48GP
Home2024Retail,N69X7-73KPT-899FD-P8HQ4-QGTP4
HomeBusiness2024Retail,PRKQM-YNPQR-77QT6-328D7-BD223
Outlook2024Retail,2CFK4-N44KG-7XG89-CWDG6-P7P27
PowerPoint2024Retail,CT2KT-GTNWH-9HFGW-J2PWJ-XW7KJ
ProjectPro2024Retail,GNJ6P-Y4RBM-C32WW-2VJKJ-MTHKK
ProjectStd2024Retail,C2PNM-2GQFC-CY3XR-WXCP4-GX3XM
ProPlus2024Retail,VWCNX-7FKBD-FHJYG-XBR4B-88KC6
VisioPro2024Retail,HGRBX-N68QF-6DY8J-CGX4W-XW7KP
VisioStd2024Retail,VBXPJ-38NR3-C4DKF-C8RT7-RGHKQ
Word2024Retail,XN33R-RP676-GMY2F-T3MH7-GCVKR
ExcelVolume,9C2PK-NWTVB-JMPW8-BFT28-7FTBF
Excel2019Volume,TMJWT-YYNMB-3BKTF-644FC-RVXBD
Excel2021Volume,NWG3X-87C9K-TC7YY-BC2G7-G6RVC
Excel2024Volume,F4DYN-89BP2-WQTWJ-GR8YC-CKGJG
PowerPointVolume,J7MQP-HNJ4Y-WJ7YM-PFYGF-BY6C6
PowerPoint2019Volume,RRNCX-C64HY-W2MM7-MCH9G-TJHMQ
PowerPoint2021Volume,TY7XF-NFRBR-KJ44C-G83KF-GX27K
PowerPoint2024Volume,CW94N-K6GJH-9CTXY-MG2VC-FYCWP
ProPlusVolume,XQNVK-8JYDB-WJ9W3-YJ8YR-WFG99
ProPlus2019Volume,NMMKJ-6RK4F-KMJVX-8D9MJ-6MWKP
ProPlus2021Volume,FXYTK-NJJ8C-GB6DW-3DYQT-6F7TH
ProPlus2024Volume,XJ2XN-FW8RK-P4HMP-DKDBV-GCVGB
ProjectProVolume,YG9NW-3K39V-2T3HJ-93F3Q-G83KT
ProjectPro2019Volume,B4NPR-3FKK7-T2MBV-FRQ4W-PKD2B
ProjectPro2021Volume,FTNWT-C6WBT-8HMGF-K9PRX-QV9H8
ProjectPro2024Volume,FQQ23-N4YCY-73HQ3-FM9WC-76HF4
ProjectStdVolume,GNFHQ-F6YQM-KQDGJ-327XX-KQBVC
ProjectStd2019Volume,C4F7P-NCP8C-6CQPT-MQHV9-JXD2M
ProjectStd2021Volume,J2JDC-NJCYY-9RGQ4-YXWMH-T3D4T
ProjectStd2024Volume,PD3TT-NTHQQ-VC7CY-MFXK3-G87F8
PublisherVolume,F47MM-N3XJP-TQXJ9-BP99D-8K837
Publisher2019Volume,G2KWX-3NW6P-PY93R-JXK2T-C9Y9V
Publisher2021Volume,2MW9D-N4BXM-9VBPG-Q7W6M-KFBGQ
SkypeforBusinessVolume,869NQ-FJ69K-466HW-QYCP2-DDBV6
SkypeforBusiness2019Volume,NCJ33-JHBBY-HTK98-MYCV8-HMKHJ
SkypeforBusiness2021Volume,HWCXN-K3WBT-WJBKY-R8BD9-XK29P
SkypeforBusiness2024Volume,4NKHF-9HBQF-Q3B6C-7YV34-F64P3
StandardVolume,JNRGM-WHDWX-FJJG3-K47QV-DRTFM
Standard2019Volume,6NWWJ-YQWMR-QKGCB-6TMB3-9D9HK
Standard2021Volume,KDX7X-BNVR8-TXXGX-4Q7Y8-78VT3
Standard2024Volume,V28N4-JG22K-W66P8-VTMGK-H6HGR
VisioProVolume,PD3PC-RHNGV-FXJ29-8JK7D-RJRJK
VisioPro2019Volume,9BGNQ-K37YR-RQHF2-38RQ3-7VCBB
VisioPro2021Volume,KNH8D-FGHT4-T8RK3-CTDYJ-K2HT4
VisioPro2024Volume,B7TN8-FJ8V3-7QYCP-HQPMV-YY89G
VisioStdVolume,7WHWN-4T7MP-G96JF-G33KR-W8GF4
VisioStd2019Volume,7TQNQ-K3YQQ-3PFH7-CCPPM-X4VQ2
VisioStd2021Volume,MJVNY-BYWPY-CWV6J-2RKRT-4M8QG
VisioStd2024Volume,JMMVY-XFNQC-KK4HK-9H7R3-WQQTV
WordVolume,WXY84-JN2Q9-RBCCQ-3Q3J3-3PFJ6
accessVolume,GNH9Y-D2J4T-FJHGG-QRVH7-QPFDW
access2019Volume,9N9PT-27V4Y-VJ2PD-YXFMF-YTFQT
access2021Volume,WM8YG-YNGDD-4JHDC-PG3F4-FC4T4
access2024Volume,82FTR-NCHR7-W3944-MGRHM-JMCWD
mondoVolume,HFTND-W9MK4-8B7MJ-B6C4G-XQBR2
outlookVolume,R69KK-NTPKF-7M3Q4-QYBHW-6MT9B
outlook2019Volume,7HD7K-N4PVK-BHBCQ-YWQRW-XW4VK
outlook2021Volume,C9FM6-3N72F-HFJXB-TM3V9-T86R9
outlook2024Volume,D2F8D-N3Q3B-J28PV-X27HD-RJWB9
word2019Volume,PBX3G-NWMT6-Q7XBW-PYJGG-WXD33
word2021Volume,TN8H9-M34D3-Y64V9-TR72V-X79KV
word2024Volume,MQ84N-7VYDM-FXV7C-6K7CC-VFW9J
ProjectProXVolume,WGT24-HCNMF-FQ7XH-6M8K7-DRTW9
ProjectStdVolume,GNFHQ-F6YQM-KQDGJ-327XX-KQBVC
ProjectStdXVolume,D8NRQ-JTYM3-7J2DX-646CT-6836M
VisioProXVolume,69WXN-MBYV6-22PQG-3WGHK-RM6XC
VisioStdVolume,7WHWN-4T7MP-G96JF-G33KR-W8GF4
VisioStdXVolume,NY48V-PPYYH-3F4PX-XJRKJ-W4423
ProPlusSPLA2021Volume,JRJNJ-33M7C-R73X3-P9XF7-R9F6M
StandardSPLA2021Volume,BQWDW-NJ9YF-P7Y79-H6DCT-MKQ9C
'@ | ConvertFrom-Csv

# Install function
function Install {
# Ensure WMI service is available before running the script
try {
    $wmiService = Get-WmiObject -Class SoftwareLicensingService -ErrorAction Stop
} catch {
    Write-Host "Error accessing WMI service: $_"
    Start-Sleep 4
    return
}

# Define registry path and value
$regPath = "HKLM:\SOFTWARE\Microsoft\Office\ClickToRun\Configuration"

# Get ProductReleaseIds registry value and process it
try {
    $productReleaseIds = (Get-ItemProperty -Path $regPath -ea 0).ProductReleaseIds
} catch {
    Write-Host "Error accessing registry: $_"
    Start-Sleep 4
    return
}    
if ($productReleaseIds) {
    $productReleaseIds -split ',' | ForEach-Object {
        $productKey = $_.Trim()
        $pKey = $KeyBlock | ? SKU -EQ $productKey | Select -ExpandProperty KEY
        if ($pKey) {
            try {
                $wmiService.InstallProductKey($pKey) | Out-Null
                Write-Host "Installed key for: ${productKey}"
            } catch {
                Write-Host "Failed to install key for ${productKey}: $_"
                Start-Sleep 4
                return
            }
        }
    }
} else {
    Write-Host
    Write-Host "ERROR: ProductReleaseIds not found." -ForegroundColor Red
    Start-Sleep 2
    return
}

$base64 = @'
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
'@

# Decode the Base64 string back into a byte array
$compressedDllBytes = [Convert]::FromBase64String($base64)

# Step 2: Create a MemoryStream from the byte array
$compressedStream = [System.IO.MemoryStream]::new($compressedDllBytes)

# Step 3: Decompress the byte array using GZip
$gzipStream = New-Object System.IO.Compression.GZipStream($compressedStream, [System.IO.Compression.CompressionMode]::Decompress)
$decompressedStream = New-Object System.IO.MemoryStream

# Copy the decompressed data to a new MemoryStream
$gzipStream.CopyTo($decompressedStream)
$gzipStream.Close()

# Step 4: Get the decompressed byte array
$decompressedDllBytes = $decompressedStream.ToArray()
    
# Define the output file path with ProgramFiles environment variable
$sppc = [System.IO.Path]::Combine($env:ProgramFiles, "Microsoft Office\root\vfs\System\sppc.dll")

# Define paths for symbolic link and target
$sppcs = [System.IO.Path]::Combine($env:ProgramFiles, "Microsoft Office\root\vfs\System\sppcs.dll")
$System32 = [System.IO.Path]::Combine($env:windir, "System32\sppc.dll")

# Step 1: Check if the symbolic link exists and remove it if necessary
if (Test-Path -Path $sppcs) {
    Write-Host "Symbolic link already exists at $sppcs. Attempting to remove..."

    try {
        # Remove the existing symbolic link
        Remove-Item -Path $sppcs -Force
        Write-Host "Existing symbolic link removed successfully."
    } catch {
        Write-Host "Failed to remove existing symbolic link: $_"
    }
} else {
    Write-Host "No symbolic link found at $sppcs."
}

try {
    # Attempt to write byte array to the file
    [System.IO.File]::WriteAllBytes($sppc, $decompressedDllBytes)
    Write-Host "Byte array written successfully to $sppc."
} 
catch {
    Write-Host "Failed to write byte array to ${sppc}: $_"

    # Inner try-catch to handle the case where the file is in use
    try {
        Write-Host "File is in use or locked. Attempting to move it to a temp file..."

        # Generate a random name for the temporary file in the temp folder
        $tempDir = [System.IO.Path]::GetTempPath()
        $tempFileName = [System.IO.Path]::Combine($tempDir, [System.Guid]::NewGuid().ToString() + ".bak")

        # Move the file to the temp location with a random name
        Move-Item -Path $sppc -Destination $tempFileName -Force
        Write-Host "Moved file to temporary location: $tempFileName"

        # Retry the write operation after moving the file
        [System.IO.File]::WriteAllBytes($sppc, $decompressedDllBytes)
        Write-Host "Byte array written successfully to $sppc after moving the file."

    } catch {
        Write-Host "Failed to move the file or retry the write operation: $_"
    }
}

# Step 3: Check if the symbolic link exists and create it if necessary
try {
    if (-not (Test-Path -Path $sppcs)) {
        # Create symbolic link only if it doesn't already exist
        New-Item -Path $sppcs -ItemType SymbolicLink -Target $System32 | Out-Null
        Write-Host "Symbolic link created successfully at $sppcs."
    } else {
        Write-Host "Symbolic link already exists at $sppcs."
    }
} catch {
    Write-Host "Failed to create symbolic link at ${sppcs}: $_"
}
	
# Define the target registry key path
$RegPath = "HKCU:\Software\Microsoft\Office\16.0\Common\Licensing\Resiliency"

# Define the value name and data
$ValueName = "TimeOfLastHeartbeatFailure"
$ValueData = "2040-01-01T00:00:00Z"

# Check if the registry key exists. If not, create it.
# The -Force parameter on New-Item ensures the full path is created if necessary.
if (-not (Test-Path -Path $RegPath)) {
	Write-host "Registry key '$RegPath' not found. Creating it."
	# Use -Force to create the key and any missing parent keys
	# Out-Null is used to suppress the output object from New-Item
	New-Item -Path $RegPath -Force | Out-Null
}

# Set the registry value within the existing (or newly created) key.
# The -Force parameter on Set-ItemProperty ensures the value is created if it doesn't exist
# or updated if it does exist.
Write-host "Setting registry value '$ValueName' at '$RegPath'."
Set-ItemProperty -Path $RegPath -Name $ValueName -Value $ValueData -Type String -Force
}

# Remove function
function Remove {
    
# Remove the symbolic link if it exists
$sppcs = [System.IO.Path]::Combine($env:ProgramFiles, "Microsoft Office\root\vfs\System\sppcs.dll")
if (Test-Path -Path $sppcs) {
	try {
		Remove-Item -Path $sppcs -Force
		Write-Host "Symbolic link '$sppcs' removed successfully."
	} catch {
		Write-Host "Failed to remove symbolic link '$sppcs': $_"
	}
} else {
	Write-Host "No symbolic link found at '$sppcs'."
}

# Remove the actual DLL file if it exists
$sppc = [System.IO.Path]::Combine($env:ProgramFiles, "Microsoft Office\root\vfs\System\sppc.dll")
if (Test-Path -Path $sppc) {
	try {
		# Try to remove the file and handle any errors if they occur
		Remove-Item -Path $sppc -Force -ErrorAction Stop
		Write-Host "DLL file '$sppc' removed successfully."
	} catch {
		Write-Host "Failed to remove DLL file '$sppc': $_"
		
		# If removal failed, try to move the file to a temporary location
		try {
			# Generate a random name for the file in the temp directory
			$tempDir = [System.IO.Path]::GetTempPath()
			$tempFileName = [System.IO.Path]::Combine($tempDir, [System.Guid]::NewGuid().ToString() + ".bak")
		
			# Attempt to move the file to the temp directory with a random name
			Move-Item -Path $sppc -Destination $tempFileName -Force -ErrorAction Stop
			Write-Host "DLL file moved to Temp folder."
		} catch {
			Write-Host "Failed to move DLL file '$sppc' to temporary location: $_"
		}
	}
} else {
	Write-Host "No DLL file found at '$sppc'."
}
}

# Clear the screen
cls
Write-Host
Write-Host "Welcome to the oHook DLL Installtion Script" -ForegroundColor Cyan
Write-Host "-------------------------------------------"
Write-Host


Install

Write-Host "--------------------------------------"
Write-Host "Script execution completed."
Start-Sleep 5


# SIG # Begin signature block
# MIIFoQYJKoZIhvcNAQcCoIIFkjCCBY4CAQExCzAJBgUrDgMCGgUAMGkGCisGAQQB
# gjcCAQSgWzBZMDQGCisGAQQBgjcCAR4wJgIDAQAABBAfzDtgWUsITrck0sYpfvNR
# AgEAAgEAAgEAAgEAAgEAMCEwCQYFKw4DAhoFAAQUlrbJO+El1c+C7mmNifwRaQL3
# BxWgggM2MIIDMjCCAhqgAwIBAgIQSe49BypwLKhOHkzMeRKLBzANBgkqhkiG9w0B
# AQsFADAgMR4wHAYDVQQDDBVhZG1pbkBvZmZpY2VydG9vbC5vcmcwHhcNMjQwMTA2
# MTYxMjI3WhcNMzAwMTA2MTYyMjI3WjAgMR4wHAYDVQQDDBVhZG1pbkBvZmZpY2Vy
# dG9vbC5vcmcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDLZq+Rmrz4
# wwNvgAZVzvbOmj1RlUll7htG/vIJurDabWNvIbYBxycLrzEAJKeuuO8TTtodlhCF
# kvCtzO2gU47wKwqoIK9p5orB9f0xasuxtu7EeIRvXZLpBjKQ20Fnzed6peoPupEb
# 5+2FIjAbM3ErtSbmC7XDhSLhAheV8+Urio/vv7zhiI0JYsfKtcZnbFBG8h5WOoYS
# k7vEF6nW4OleuM6oGuprq7OWDYGLa9sarX8mjNu0CPDgvxoE6vAiOY6lXgT9GoSn
# EOgpn8OOhpBp9ERPzP6Qq6qetl/+wYGkYbQGz7v6fPDQ4ATnGFIfc9G+qICE8iZs
# TV+bgDYjyMUJAgMBAAGjaDBmMA4GA1UdDwEB/wQEAwIHgDATBgNVHSUEDDAKBggr
# BgEFBQcDAzAgBgNVHREEGTAXghVhZG1pbkBvZmZpY2VydG9vbC5vcmcwHQYDVR0O
# BBYEFDIRoZpOPb0eh3mSqlUpHSSgioiqMA0GCSqGSIb3DQEBCwUAA4IBAQCe7S09
# 5VqCa9rw0s6FdNqvHOftRgRf1or04i7ZuV3jffN/rValXj8O7GtTRQ9ZFhGInjZ/
# 5UVyLPnhVqVwWzNpqFgTL5/Y0joFQ99GQfv1f5UUt6U4jNjjSTZNdVa3C9iwV4IQ
# jaRhGEQqsvqsOadezbX9jlIpXBKxmua70/cUj8Ub0UBT+jrt3ztqsX/Ei/wrorbh
# 8qS1rgYmi493hgQgKxSG/7tZ5PvbljEO5KPEMagKF6u4XX1B7Mz0DQAJcFUnTsNy
# D/Tj8nc03aYnF8NRkUyRYPhbIgpiY9e7/ivBY+4gF20ONc1Cy8+zqgSn17mF1QTD
# TOzL7jtV+7ROPKxOMYIB1TCCAdECAQEwNDAgMR4wHAYDVQQDDBVhZG1pbkBvZmZp
# Y2VydG9vbC5vcmcCEEnuPQcqcCyoTh5MzHkSiwcwCQYFKw4DAhoFAKB4MBgGCisG
# AQQBgjcCAQwxCjAIoAKAAKECgAAwGQYJKoZIhvcNAQkDMQwGCisGAQQBgjcCAQQw
# HAYKKwYBBAGCNwIBCzEOMAwGCisGAQQBgjcCARUwIwYJKoZIhvcNAQkEMRYEFPdY
# xwzoCtnRsjzUEaM/4lqB5qxiMA0GCSqGSIb3DQEBAQUABIIBAMnVvL69KR9xanMY
# fxsL4L04G+XllCWfsKuTQshWTVrqARgZDqDvuwaInZlj1EYwrrX0Jg45mdPiZXAF
# o4Mtw32++IaXK+JKhrrH/1YrQTAUAEo0e0OGFLhCGBRtSnVRuBGSZG4fnHFhj5hc
# iUV0phIQuIXf/RQ0qyT37kHIhVXgv6FHFZkynX2kZ7jobUZ3mW/58fICYp2aT5y6
# tJniSG5L7LZYSVNaHZ02kjf/NBcDZRvPt44FXbnQNjjbT9rwAkOnwHj6A5HmizZ/
# 1zkVbKTHEXkMfJt/3Jy0ZIXuCJcbPhZT5Y6GtBfj21omjL0hQIyph6riyeI7KCp6
# 44BScrw=
# SIG # End signature block
